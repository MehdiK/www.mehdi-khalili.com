module.exports = (BasePlugin) ->
  fs = require('fs')
  path = require('path')

  class CanonicalUrl extends BasePlugin
    name: 'canonicalurl'
    fileToUrl = (fileName) ->

      # posts
      match = fileName.match(/\d{4}-\d{2}-\d{2}-([A-Za-z0-9-]*).html$/)
      if match and match.length > 1
        return '/' + match[1]

      # tags
      match = fileName.match(/(\/tagged\/[A-Za-z0-9-]*).html$/)
      if match and match.length > 1
        return match[1]

      # tags
      match = fileName.match(/(\/archive[0-9.]*).html$/)
      if match and match.length > 1
        return match[1]

      return fileName

    writeAfter: (opts, next) -> 
      docs = @docpad.getCollection('documents').toJSON()

      routes = docs.map((doc) -> { url: doc.resource || fileToUrl(doc.url), file: doc.url })

      fs.writeFile(
        path.join(@docpad.config.outPath, 'routes.json'),
        JSON.stringify({ routes: routes }, null, "\t"),
        next
        )

      @
